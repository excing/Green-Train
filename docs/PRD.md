1.  **架构上，追求极致的“无状态”**：后端彻底变为一个“调度与连接中心”，不承载任何聊天内容，这最大化地降低了服务器成本和用户隐私风险。
2.  **功能上，增加了社交的“公共空间”**：“车厢群聊”让原本1v1的私密交流，增加了一个公共场域，让整个“旅途”的社交体验更多元。

---

## **“同频列车”产品需求文档 (PRD)**

* **文档版本:** V1.0
* **创建日期:** 2025年7月18日
* **作者:** Gemini

| 版本 | 日期 | 主要变更内容 |
| :--- | :--- | :--- |
| V1.0 | 2025/07/18 | 初版创建，整合所有核心功能、技术架构及最新需求。 |

### **1. 产品概述**

“同频列车”是一款以“慢社交”和“氛围体验”为核心的即时交流应用。它摒弃了传统社交应用中令人疲惫的个人主页和关系维护，通过模拟“乘坐一趟有始有终的列车”的体验，为用户提供一个在特定主题下，与陌生人进行限时、低压、高质量交流的纯粹空间。产品的核心是“短暂相遇，不留负担”，强调交流过程本身而非结果。

### **2. 目标用户**

* 对现有快餐式社交应用感到疲惫的都市青年。
* 渴望深度交流但害怕社交压力的内向者。
* 拥有特定兴趣爱好，希望找到同频伙伴的用户（如影迷、书迷、乐迷）。
* 注重个人隐私，不希望社交行为被过度记录的用户。

### **3. 核心设计原则**

* **阅后即焚 (Ephemeral First):** 交流是短暂的，关系不被强制延续。服务器不存储任何用户聊天记录。
* **氛围优先 (Atmosphere over Function):** 沉浸式体验（如时刻表、车窗风景）是产品的核心吸引力。
* **零成本运营 (Zero-Cost Operation):** 技术选型和功能设计优先考虑在免费额度内运行。
* **低压社交 (Low Pressure):** 用户无需维护复杂的个人资料，交流结束即是终点，没有社交负担。

### **4. 功能需求 (Functional Requirements)**

#### **4.1 车站大厅与时刻表 [P0 - 核心]**

* **4.1.1 车站大屏:** App主界面为一个“列车时刻表”，实时显示即将“发车”的列车信息。
* **4.1.2 列车信息:** 每趟列车需展示：车次、目的地（主题）、途经站点、发车时间、终到时间、状态（候车中/正在检票/已出发）。
* **4.1.3 站点详情:** 用户可点击查看列车的详细“站点列表”，了解每个站点的子主题和运行时长。

#### **4.2 票务系统 [P0 - 核心]**

* **4.2.1 车票获取:**
    * **每日补给:** 用户每日首次登录可自动获得3张“普通车票”（车票有时效性，不累加）。
    * **邀请奖励:** 用户通过专属邀请链接成功邀请一位新用户（新用户需完成首次旅行），邀请者可获得5张“普通车票”。被邀请者可获得含5张车票的“新人礼包”。
* **4.2.2 购票流程:**
    * 用户在时刻表选择车次，进入购票界面。
    * 用户需选择“上车站”和“下车站”来确定自己的旅程。
    * 系统根据乘坐站数计算所需车票（1站=1票），扣除车票后生成一张虚拟纪念车票。

#### **4.3 旅程与匹配 [P0 - 核心]**

* **4.3.1 自动调度:** 后端服务（Vercel Cron Job）每分钟轮询一次，检查是否有列车到达预定发车时间。
* **4.3.2 邻座匹配:**
    * 列车“发车”时，后端将所有持有该车次车票的乘客进行随机的1v1配对。
    * 配对信息（如对方的匿名和FCM标识）下发给客户端，用于建立私聊通道。
* **4.3.3 车厢群聊建立:**
    * 列车“发车”时，后端为该车次所有乘客创建一个唯一的FCM主题（Topic），作为“车厢群聊”的广播频道。

#### **4.4 交流系统 [P0 - 核心]**

* **4.4.1 消息收发架构:**
    * **原则:** 所有消息（私聊/群聊）均由FCM作为传输通道，后端仅作转发，**不在数据库中存储任何聊天记录**。
    * **客户端存储:** 聊天记录由用户客户端本地保存。清除缓存、重装应用或更换设备将导致历史消息丢失，此为产品特性，需在用户协议中明确。
* **4.4.2 邻座私聊 (1v1):**
    * 用户A向用户B发送消息，消息通过FCM直接推送到用户B的设备。
    * 聊天窗口为两人私密空间，对话随旅程结束而结束。
* **4.4.3 车厢群聊 (Group):**
    * 用户可切换到“车厢”频道。
    * 发送一条“车厢消息”，客户端将消息上报给后端函数。
    * 后端函数将该消息通过FCM广播给该车次对应的FCM主题，所有订阅了该主题的“乘客”都会收到此消息。

#### **4.5 车窗风景 [P1 - 重要]**

* **4.5.1 视觉呈现:** 聊天界面上半部分为一扇较大的“车窗”，用于展示风景。
* **4.5.2 内容形式:** 采用多张静态图片轮播的形式。图片内容需与列车主题和当前站点强相关。
* **4.5.3 动态效果:** 图片切换采用柔和的“淡入淡出”效果，并对单张图片应用缓慢的“平移与缩放”（肯·伯恩斯）效果，营造动态感。

#### **4.6 用户系统 [P1 - 重要]**

* **4.6.1 用户认证:** 使用Firebase Authentication处理用户的注册与登录。
* **4.6.2 极简资料:** 用户资料仅包含一个昵称和头像，无需其他复杂信息。
* **4.6.3 邀请功能:** 用户可在个人中心生成专属邀请链接，用于邀请好友。

### **5. 技术架构**

* **前端:** SvelteKit v5，便于实现网页端和PWA。
* **后端(无状态, 微服务):** SvelteKit API。
* **部署:** Vercel.
* **数据库:** Firestore (仅存储用户资料、票务信息、列车时刻表等非消息数据)。
* **认证:** Firebase Authentication, 支持匿名登录和 Google 登录。
* **图片资源:** 第三方服务。
* **消息通道:** **Firebase Cloud Messaging (FCM)** 作为唯一的消息传输层。后端只做无状态的消息转发，不持久化存储。

### **6. 非功能性需求**

* **隐私与安全:** 必须在用户协议和产品引导中明确告知用户“服务器不保存聊天记录”的特性。所有通信应加密。
* **性能:** 应用加载速度快，界面响应流畅。
* **可扩展性:** Serverless架构可自动扩展，但需密切关注Firebase免费套餐的用量，特别是Firestore的读写次数。
* **Cookie 隐私政策:** 支持 GDPR 合规.

### **7. V1.0 MVP范围**

以上标记为 `[P0 - 核心]` 和 `[P1 - 重要]` 的功能均包含在V1.0的最小可行产品范围内。其他更复杂的奖励机制、个性化设置等可延后考虑。