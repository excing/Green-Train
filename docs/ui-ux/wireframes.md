# WebGreenTrain2 UI/UX 文档（线框稿与交互说明）

本文档定义 WebGreenTrain2 的关键界面与交互（中文），覆盖首页（12306/航班式）、详情、购票确认、候车室、聊天室、我的票、签到与积分，以及通用组件与视觉可用性建议。整体遵循“临时聊天、阅后即焚、无服务端历史、双时区显示”的目标。

目录
- 1 设计目标与原则
- 2 全局信息架构（IA）
- 3 首页（12306/航班样式）文本线框与字段映射
- 4 车次详情
- 5 购票确认
- 6 候车室
- 7 聊天室
- 8 我的票
- 9 签到与积分
- 10 组件规范
- 11 视觉与可用性


1) 设计目标与原则

- 临时聊天：围绕“同一趟列车（主题活动）”形成短时会话。
- 阅后即焚：消息不在服务端持久化；房间关闭或用户到达后本地清空普通消息，仅保留“收藏”。
- 无服务端历史：仅通过 FCM 实时分发，客户端使用 IndexedDB 本地存储与去重排序。
- 双时区显示：所有关键时刻（发车/到达/开售/停售/倒计时）支持“本地时区 / 车次时区（train.timezone）”切换与同步展示。


2) 全局信息架构（IA）

- 标题栏（App Bar）
  - 品牌/Logo：Green Train；点击回首页。
  - 导航：我的票 / 积分 / 帮助。
  - 时间模式切换：切换“显示主/辅时区”（主：本地；辅：车次，或反之）。
  - 积分余额徽章：显示剩余积分 points_remaining；旁边提供“签到 +X”按钮/入口（X=匿名 10 / Google 20，动态文案）。
  - 用户认证入口：支持匿名与 Google 登录；显示当前身份（匿名/Google 头像与昵称）。

- 顶部搜索区（站点/时间/主题）
  - 出发站 / 到达站：站点自动完成，支持“交换”按钮。
  - 出发日期：仅可选“未来 N 天”窗口内的可运行日（按照数据规范合并后的 service_date）。
  - 时段筛选：全天 / 早晨 / 白天 / 晚间；或自定义起止时段（HH:mm）。
  - 主题关键词：对 theme/name/stations[].name 模糊查询。
  - 查询按钮：触发筛选与排序；
  - 轻提示：
    - 仅展示未来 N 天的运行日；
    - 跨日采用“+dd”相对标注（例如 00:40+01 表示次日 00:40）。

- 结果区（表格/航班式）
  - 字段：车次/主题、出发（站/时）、到达（站/时）、历时、售卖状态、积分消耗、操作（详情/购票）。
  - 行内展开：
    - 全时刻表（含到/发绝对时间：本地/车次时区双视图）；
    - 段积分（stations[].points）汇总；
    - 服务日与售卖规则（status/status_note、sales_open_rel、sales_close_before_departure_minutes）。
  - 排序与筛选：
    - 排序：按最近可运行/可售的一班发车时间（主时区）升序；
    - 筛选：售卖状态、主题、时段、是否跨日等。

- 底部区域
  - 分页或无限滚动：按性能与数据量二选一。
  - 空/错误/骨架占位：无结果、接口异常、加载中状态清晰可见。


3) 首页（12306/航班样式）文本线框与字段映射

- 桌面线框（文本描述）
  1. App Bar（左）Logo/品牌；（中）导航：我的票/积分/帮助；（右）时间切换、积分余额徽章、签到 +X、用户头像/登录入口。
  2. 搜索条：
     - [出发站 | 自动完成] [⇄] [到达站 | 自动完成] [日期选择 | 未来 N 天] [时段] [关键词] [查询]
  3. 航班式结果表：
     - 表头：车次/主题 | 出发（站/时） | 到达（站/时） | 历时 | 售卖状态 | 积分 | 操作
     - 行：
       - 车次/主题：K7701｜聊聊诺兰的新电影 [状态徽标]
       - 出发：起始站｜08:35（主）｜08:35（辅）
       - 到达：终点站｜09:45（主）｜09:45（辅）
       - 历时：1小时10分（跨日在到达处以 +dd 点亮）
       - 售卖状态：可购/未开售(09:00)/已停售/暂停/隐藏
       - 积分：3（按 from→to 段 points 汇总）
       - 操作：[详情] [购票]
     - 展开：显示全时刻表、售卖规则、服务日。

- 移动线框（文本描述）
  - 搜索区收叠为两行：第一行出发/到达/交换；第二行日期/时段/关键词；
  - 结果以卡片显示：顶部为车次/主题 + 状态徽标；中部两列为出发/到达（主时区大号时间，辅时区小号灰色）；底部为历时 + 积分 + 操作按钮。

- 字段与状态映射表（结果表/卡片）
  - 车次/主题：
    - 来源：train.id + train.theme；
    - 状态徽标映射：
      - active → 无特殊徽标或“可购”绿点；
      - paused → “暂停”橙色；
      - deprecated → “即将下线”灰黄；
      - hidden → 默认不展示；开启“显示隐藏”开关后以“隐藏”灰徽标显示；
      - archived/draft → 不出现在列表；
      - status_note：以 Tooltip/Icon 展示。
  - 出发（站/时）：
    - 站名：stations[from].name；
    - 时间：
      - 主时区：journey_depart_local 或 journey_depart_train 取决于切换；
      - 辅时区：另一套时间，以小字标注；
      - 跨日：使用 +dd 标识（例如 00:40+01）。
  - 到达（站/时）：同上，使用 journey_arrival_* 字段。
  - 历时：arrival_abs − depart_abs（分钟→人类可读）。
  - 售卖状态：
    - 计算：is_on_sale(now, service_date, from_index)；
    - 映射：
      - true → 可购；
      - false 且 now < open_at → 未开售（显示 open_at 主/辅时区）；
      - false 且 now ≥ close_at → 已停售；
      - status=paused → 暂停；
      - status=hidden → 隐藏（默认不列出，开启开关后以“隐藏”灰徽标）；
    - 不在运行日：默认不展示；如展示则标注“非运行日”。
  - 积分消耗：points_cost = Σ stations[k].points (k ∈ (from, to])；无配置按 0 处理。
  - 操作：
    - [详情] 跳转车次详情；
    - [购票] 若不可售则禁用并显示原因 Tooltip。


4) 车次详情

- 可运行日（日历）：仅展示“未来 N 天”的 service_date；不可运行日置灰；
- 售卖状态：开售/停售动态计算，显示 open_at/close_at（主/辅时区）；
- 站点选择：选择上/下车站（仅允许 from_index < to_index），动态计算历时与积分；
- 时间显示：journey_depart_local/train + journey_arrival_local/train 四字段；
- 积分预估：根据 from/to 实时汇总 stations[].points；
- 进入购票确认：校验单用户单车限制（重叠行程阻止）。


5) 购票确认

- 选座策略：
  - 顺序（sequential）：车厢→行→A/B/C/D/F；
  - 智能随机（smart_random）：靠近已有乘客的伪随机，空车优先 C→D/B→F→A；
- 积分：展示 points_cost、points_remaining，并确保余额足够方可下单；
- 单用户单车限制：提示“进行中时间窗重叠将拒绝下单”；
- 须知：
  - 阅后即焚：消息不在服务端持久化；
  - 本地消息：IndexedDB 保存，房间关闭或到达后清空普通消息；
- 成功：展示 pnr_code 与二维码入口；引导“前往候车室”。


6) 候车室

- 票面：显示 pnr_code、二维码（qrcode_payload）、席位码 seat_code（如 3车 07D）。
- 倒计时：距发车/到达的倒计时（主/辅时区切换）。
- 入口：根据票据生成的 room_ids 进入全车/车厢/同排/席位频道；
- 退票：在到达前可退票；积分按“取消当天”退回，幂等。
- 时间切换：与全局一致。


7) 聊天室

- 频道切换：全局/车厢/同排（不建议直接进入席位频道发言）。
- 消息区：
  - sent_at 双视图：主/辅时区时间；
  - 展示 seat_code（如 07D）；
  - 去重排序：sent_at + client_msg_id；
- 输入区：文本输入、发送、收藏（星标）；
- 收藏（IndexedDB）：本地收藏消息独立存储，不随清空策略删除；
- 房间状态：pending/open/closed 计算，不落库；
- 关闭清空：closed 或用户到达后清空普通消息并退订 FCM topic。


8) 我的票

- 分组：进行中 / 已完成 / 已取消。
- 退票：发车后也可退（到达前），积分按“取消当天”退回（幂等）。
- 单车限制提示：当存在进行中行程时，明确提示“当前处于另一趟列车行程中”。


9) 签到与积分

- 手动签到：
  - 按“用户本地时区”自然日；
  - 匿名用户 +10 积分；Google 登录用户 +20 积分；
  - 可累加；同一自然日幂等，不重复加分；
- 余额展示：App Bar 徽章与“积分”页面均展示 points_remaining；
- 登录引导与 provider 切换：
  - 未登录或匿名可提示绑定/切换到 Google；
  - 支持账户 link/unlink，切换后保留积分余额；
  - 未签到但余额足够仍可购票。


10) 组件规范

- 时间切换控件：主/辅时区切换；默认主=本地，辅=车次；
- 站点选择器：自动完成 + 交换；from 必须在 to 之前；
- 选座策略开关：sequential / smart_random；
- 倒计时：目标为发车/到达；支持暂停/继续；
- 状态徽标：active/paused/deprecated/hidden 等；
- 错误与空态文案：
  - 空：未找到匹配车次；
  - 错误：网络异常 / 数据解析失败；
  - 禁售：未开售/已停售/暂停；
- 骨架屏：表格行、详情页时刻表、聊天室消息列表均提供。


11) 视觉与可用性

- 配色 token（绿皮配色建议）：
  - 主色：#1B9A59；深绿：#0F6D3D；浅绿：#E6F6EE；
  - 状态：成功绿、警告橙、信息蓝、危险红（饱和度适中）。
- 响应式：
  - ≥ 1200px 桌面三列密集表格；
  - 768–1199px 双列卡片；
  - < 768px 单列卡片与吸顶搜索条；
- 无障碍：字号 14/16/18；对比度 ≥ 4.5:1；Tab 顺序与 ARIA 标注；
- 动效建议：
  - 列表刷新与状态变更提供轻量过渡；
  - split‑flap（翻牌式时刻表）轻动效用于“时间变化”与“开售切换”，避免喧宾夺主。
